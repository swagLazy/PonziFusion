import numpy as np
from scipy.stats import wilcoxon

ours_data = {
    'Precision': [0.9349, 0.9221, 0.9279, 0.9369, 0.9271, 0.9346, 0.9334, 0.9245, 0.9306, 0.9248],
    'Recall': [0.7533, 0.7610, 0.7584, 0.7505, 0.7559, 0.7509, 0.7533, 0.7557, 0.7555, 0.7559],
    'F1': [0.8333, 0.8329, 0.8328, 0.8328, 0.8308, 0.8305, 0.8303, 0.8303, 0.8302, 0.8301],
    'ROC-AUC': [0.9672, 0.9668, 0.9610, 0.9633, 0.9644, 0.9636, 0.9657, 0.9653, 0.9622, 0.9628],
    'AUC-PR': [0.8563, 0.8581, 0.8477, 0.8563, 0.8599, 0.8563, 0.8586, 0.8590, 0.8551, 0.8507]
}

baselines = {
    'RandomForest': {
        'Precision': [0.9165, 0.9146, 0.9215, 0.8966, 0.9183, 0.9200, 0.9153, 0.9050, 0.8696, 0.9146],
        'Recall': [0.5641, 0.5385, 0.6410, 0.6667, 0.5897, 0.6154, 0.7105, 0.5128, 0.5128, 0.5385],
        'F1': [0.7097, 0.6885, 0.7692, 0.7647, 0.7302, 0.7619, 0.8182, 0.6780, 0.6452, 0.6885],
        'ROC-AUC': [0.9565, 0.9354, 0.9686, 0.9581, 0.9726, 0.9480, 0.9472, 0.8960, 0.9299, 0.9468],
        'AUC-PR': [0.8241, 0.7921, 0.8630, 0.8187, 0.8434, 0.8342, 0.8460, 0.7128, 0.7327, 0.8273]
    },
    'XGBoost': {
        'Precision': [0.9155, 0.9203, 0.9250, 0.8824, 0.9155, 0.9100, 0.9207, 0.9000, 0.8889, 0.8929],
        'Recall': [0.6410, 0.6923, 0.6923, 0.7692, 0.7436, 0.6923, 0.7632, 0.5897, 0.6154, 0.6410],
        'F1': [0.7692, 0.8060, 0.8182, 0.8219, 0.8286, 0.7941, 0.8529, 0.7188, 0.7273, 0.7463],
        'ROC-AUC': [0.9429, 0.9474, 0.9536, 0.9617, 0.9345, 0.9589, 0.9472, 0.9167, 0.9571, 0.9675],
        'AUC-PR': [0.7742, 0.8266, 0.8489, 0.8619, 0.8145, 0.8541, 0.8500, 0.7760, 0.7890, 0.8275]
    },
    'LightGBM': {
        'Precision': [0.9215, 0.9267, 0.9200, 0.8824, 0.9063, 0.9150, 0.9257, 0.9167, 0.8621, 0.9150],
        'Recall': [0.6410, 0.7436, 0.6923, 0.7692, 0.7436, 0.6923, 0.7632, 0.5641, 0.6410, 0.6923],
        'F1': [0.7692, 0.8406, 0.8182, 0.8219, 0.8169, 0.7941, 0.8529, 0.6984, 0.7353, 0.7941],
        'ROC-AUC': [0.9317, 0.9482, 0.9598, 0.9613, 0.9320, 0.9665, 0.9469, 0.9123, 0.9663, 0.9637],
        'AUC-PR': [0.7644, 0.8363, 0.8531, 0.8727, 0.8249, 0.8697, 0.8470, 0.7594, 0.7989, 0.8328]
    },
    'CatBoost': {
        'Precision': [0.9243, 0.9230, 0.9250, 0.8649, 0.9063, 0.9203, 0.9267, 0.9156, 0.8519, 0.9200],
        'Recall': [0.6923, 0.6667, 0.7180, 0.8205, 0.7436, 0.6923, 0.7632, 0.5385, 0.5897, 0.6154],
        'F1': [0.8060, 0.7879, 0.8358, 0.8421, 0.8169, 0.8060, 0.8529, 0.6885, 0.6970, 0.7500],
        'ROC-AUC': [0.9328, 0.9054, 0.9512, 0.9679, 0.9333, 0.9551, 0.9514, 0.8917, 0.9305, 0.9562],
        'AUC-PR': [0.7931, 0.8164, 0.8780, 0.8749, 0.8060, 0.8496, 0.8509, 0.7569, 0.7845, 0.8389]
    },
    'Sequence': {
        'Precision': [0.8913, 0.9017, 0.9058, 0.8987, 0.9049, 0.9026, 0.9011, 0.8946, 0.8991, 0.9013],
        'Recall': [0.7177, 0.7222, 0.7171, 0.7241, 0.7234, 0.7195, 0.7173, 0.7251, 0.7178, 0.7144],
        'F1': [0.7951, 0.8020, 0.8005, 0.8020, 0.8040, 0.8007, 0.7988, 0.8010, 0.7983, 0.7970],
        'ROC-AUC': [0.9458, 0.9255, 0.9512, 0.9500, 0.9412, 0.9583, 0.9504, 0.9070, 0.9506, 0.9621],
        'AUC-PR': [0.7996, 0.7658, 0.8688, 0.7913, 0.7865, 0.8709, 0.7882, 0.7141, 0.7188, 0.8087]
    }
}


def perform_wilcoxon(ours_data, baselines, metric='F1'):
    print(f"\n{'=' * 20} Wilcoxon Test for {metric} {'=' * 20}")
    print(f"{'Baseline':<15} | {'Ours':<8} | {'Base':<8} | {'P-Value':<10} | {'Result'}")
    print("-" * 75)

    ours_scores = np.array(ours_data[metric])

    for model_name, data in baselines.items():
        if metric not in data: continue
        base_scores = np.array(data[metric])

        try:
            stat, p_val = wilcoxon(ours_scores, base_scores, alternative='greater')
            sig = "✅ Significant" if p_val < 0.05 else "❌ Not Sig"
        except ValueError:
            p_val = 1.0
            sig = "❌ Identical"

        print(f"{model_name:<15} | {ours_scores.mean():.4f}   | {base_scores.mean():.4f}   | {p_val:.2e}   | {sig}")


if __name__ == "__main__":
    metrics_to_test = ['Precision', 'Recall', 'F1', 'ROC-AUC', 'AUC-PR']

    print("PonziFusion Significance Test Report")

    for m in metrics_to_test:
        perform_wilcoxon(ours_data, baselines, metric=m)

    print("\n[Done] All tests completed.")
